<!DOCTYPE html>
<html>
<head>
    <title>Erm</title>
    <style>
        #binaryCanvas {
            display: none; /* 隐藏 canvas 元素 */
        }
    </style>
</head>
<body>
    <input type="file" id="imageUpload" accept="image/*">
    <img id="originalImage" src="testing.jpg" alt="Original Image">
    <canvas id="binaryCanvas"></canvas>
    <a id="downloadLink" style="display: none;">Download Processed Image</a>

    <script>
        function otsu(histogram, total) //copy from wiki
        {
            var sum = 0;
            for (var i = 1; i < 256; ++i)
            sum += i * histogram[i];
            var sumB = 0;
            var wB = 0;
            var wF = 0;
            var mB;
            var mF;
            var max = 0.0;
            var between = 0.0;
            var threshold1 = 0.0;
            var threshold2 = 0.0;
            for (var i = 0; i < 256; ++i) {
                wB += histogram[i];
                if (wB == 0)
                    continue;
                wF = total - wB;
                if (wF == 0)
                    break;
                sumB += i * histogram[i];
                mB = sumB / wB;
                mF = (sum - sumB) / wF;
                between = wB * wF * (mB - mF) * (mB - mF);
                if ( between >= max ) {
                    threshold1 = i;
                    if ( between > max ) {
                        threshold2 = i;
                    }
                    max = between;            
                }
            }
            return ( threshold1 + threshold2 ) / 2.0;
        }

        function calculateHistogram(data) {
            var histogram = new Array(256).fill(0);

            for (var i = 0; i < data.length; i += 4) {
                var grayValue = (data[i] + data[i + 1] + data[i + 2]) / 3;
                histogram[Math.floor(grayValue)]++;
            }

            return histogram;
        }

        function binarizeImage(data, threshold) {

        for (var i = 0; i < data.length; i += 4) {
        var grayValue = (data[i] + data[i + 1] + data[i + 2]) / 3;
        var binaryValue = (grayValue < threshold) ? 0 : 255;

        data[i] = binaryValue;
        data[i + 1] = binaryValue;
        data[i + 2] = binaryValue;
        }
}
        
        function generateDownloadLink(data) {
            var binaryCanvas = document.getElementById('binaryCanvas');
            var downloadLink = document.getElementById('downloadLink');

            var ctx = binaryCanvas.getContext('2d');
            ctx.putImageData(data, 0, 0);

            var imageDataURL = binaryCanvas.toDataURL('image/png');

            downloadLink.href = imageDataURL;
            downloadLink.onclick = function() {
                var a = document.createElement('a');
                a.href = imageDataURL;
                a.download = 'processed_image.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            downloadLink.style.display = 'block';
        }
        
        function sharpener(data,imageWidth,imageHeight,threshold) {
            for (var i = 0; i < data.length; i += 4) 
            {
                var grayValue = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                data[i] = grayValue;
                data[i + 1] = grayValue;
                data[i + 2] = grayValue;
            }
            var originalData = new Uint8ClampedArray(data);
            for (var i = 0; i < data.length; i+= 4)
            {
                var filter08 = 0;
                var filter04 = 0;
                var filter05 = originalData[i];
                var filter06 = 0;
                var filter02 = 0;
                if(data[i-imageWidth*4] != null)
                {
                    filter08 = -originalData[i-imageWidth*4];
                }
                if(data[i-4] != null)
                {
                    filter04 = -originalData[i-4]
                }
                if(data[i+4] != null)
                {
                    filter06 = -originalData[i+4]
                }
                if(data[i+imageWidth*4] != null)
                {
                    filter02 = -originalData[i+imageWidth*4];
                }
                
                filtered = filter05 *5 + filter02 +filter04 + filter06 +filter08;
                data[i] = filtered;
                data[i + 1] = filtered;
                data[i + 2] = filtered;
            }
            for (var i = 0; i < data.length; i += 4) 
            {
                var binaryValue = (data[i] < threshold) ? 0 : 255;

                data[i] = binaryValue;
                data[i + 1] = binaryValue;
                data[i + 2] = binaryValue;
            }
        }
        
        var imageUpload = document.getElementById('imageUpload');
        var originalImage = document.getElementById('originalImage');
        var binaryCanvas = document.getElementById('binaryCanvas');
        var ctx = binaryCanvas.getContext('2d');

        imageUpload.addEventListener('change', function() {
            var file = imageUpload.files[0]; 

            if (file) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    var imageDataUrl = e.target.result;
                    originalImage.src = imageDataUrl; 

                    originalImage.onload = function() {
                        var imageWidth = originalImage.width;
                        binaryCanvas.width = imageWidth;
                        var imageHeight = originalImage.height;
                        binaryCanvas.height = imageHeight;
                        var totalPixels = imageWidth * imageHeight;

                        ctx.drawImage(originalImage, 0, 0, imageWidth, imageHeight);

                        var imageData = ctx.getImageData(0, 0, imageWidth, imageHeight);
                        var data = imageData.data;

                        var histogram = calculateHistogram(data);

                        var threshold = otsu(histogram, totalPixels);
                        sharpener(data, imageWidth, imageHeight,threshold)
                        // binarizeImage(data, threshold);
                        generateDownloadLink(imageData);
                        ctx.putImageData(imageData, 0, 0); //
                        const img    = binaryCanvas.toDataURL('image/png')
                        document.getElementById('originalImage').src = img
                    };
                };

                reader.readAsDataURL(file);
            }
        });
        

    </script>
</body>
</html>
